generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              Int              @id @default(autoincrement())
  email           String           @unique
  password        String
  name            String?
  role            String           @default("user") // "admin" or "user"
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  savedEstimates  SavedEstimate[]
}

model AppSettings {
  id                  Int      @id @default(autoincrement())
  key                 String   @unique
  value               String
  updatedAt           DateTime @updatedAt
}

model Carrier {
  id              Int              @id @default(autoincrement())
  name            String           @unique
  createdAt       DateTime         @default(now())
  callRecords     CallRecord[]
  rateMatrices    RateMatrix[]
  uploadHistories UploadHistory[]
  savedEstimates  SavedEstimate[]
}

model CallRecord {
  id              Int      @id @default(autoincrement())
  userName        String
  userEmail       String
  callDate        DateTime
  duration        Int      // Duration in seconds
  callType        String   // e.g., "Outbound", "Inbound"
  sourceNumber    String?  // Source phone number
  destination     String?  // Destination phone number
  originCountry   String?  // Parsed from source number
  destCountry     String?  // Parsed from destination number
  uploadedAt      DateTime @default(now())
  carrierId       Int
  carrier         Carrier  @relation(fields: [carrierId], references: [id])

  @@index([userEmail])
  @@index([callDate])
  @@index([originCountry])
  @@index([destCountry])
  @@index([carrierId])
}

model RateMatrix {
  id              Int       @id @default(autoincrement())
  originCountry   String    // e.g., "USA", "UK"
  destination     String    // e.g., "Afghanistan", "Afghanistan-Mobile"
  destCountry     String    // Base country extracted from destination
  callType        String    // e.g., "Outbound"
  pricePerMinute  Decimal   @db.Decimal(10, 4)
  effectiveDate   DateTime?
  endDate         DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  carrierId       Int
  carrier         Carrier   @relation(fields: [carrierId], references: [id])

  @@unique([originCountry, destination, callType, carrierId])
  @@index([originCountry])
  @@index([destCountry])
  @@index([carrierId])
}

model UploadHistory {
  id             Int       @id @default(autoincrement())
  fileName       String
  fileType       String    @default("teams") // "teams" or "rates"
  recordCount    Int
  uploadedBy     String
  uploadedAt     DateTime  @default(now())
  reportMonth    Int?
  reportYear     Int?
  dateRangeStart DateTime? // Earliest call date in the upload
  dateRangeEnd   DateTime? // Latest call date in the upload
  carrierId      Int?
  carrier        Carrier?  @relation(fields: [carrierId], references: [id])

  @@index([carrierId])
}

model SavedEstimate {
  id                    Int       @id @default(autoincrement())
  name                  String

  // Form inputs
  originCountry         String
  userCount             Int
  callsPerUserPerMonth  Float
  avgMinutesPerCall     Float
  destinations          Json      // [{country, percentage}]
  carrierId             Int?
  carrier               Carrier?  @relation(fields: [carrierId], references: [id])

  // Results (stored for quick load)
  results               Json

  // Sharing
  shareToken            String?   @unique
  isPublic              Boolean   @default(false)

  // Metadata
  notes                 String?
  userId                Int
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@index([shareToken])
}
